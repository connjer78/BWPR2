<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
        body { 
            padding: 10px; 
            overflow-y: auto;
        }
        .select-wrapper {
            margin-top: 5px;
        }
        .select-button {
            width: 100%;
            text-align: left;
            padding: 5px;
            background-color: var(--ds-surface);
            border: 1px solid var(--ds-border);
            border-radius: 3px;
            cursor: pointer;
        }
        .options {
            display: none;
            position: absolute;
            background-color: var(--ds-surface);
            border: 1px solid var(--ds-border);
            border-radius: 3px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }
        .option {
            padding: 5px;
            cursor: pointer;
        }
        .option:hover {
            background-color: var(--ds-background-neutral-hovered);
        }
        .option.selected {
            background-color: var(--ds-background-neutral-selected);
        }
    </style>
</head>
<body>
    <div id="error" class="error"></div>
    <div id="content">
        <div id="member-select-container" class="select-wrapper">
            <button class="select-button">Select members</button>
            <div class="options" id="member-options"></div>
        </div>
        <div id="label-select-container" class="select-wrapper">
            <button class="select-button">Select labels</button>
            <div class="options" id="label-options"></div>
        </div>
        <div class="select-wrapper">
            <label for="newCardSuffix">New Card Suffix:</label>
            <input type="text" id="newCardSuffix" placeholder="Enter suffix here" />
        </div>
        <button id="createButton" class="mod-primary">Create Project Card</button>
    </div>
    <script>
        var TRELLO_APP_KEY = '6fd96e65b3bbfbf2c88bd5eb871fab8a'; // Your API key
        var t = window.TrelloPowerUp.iframe({
            appKey: TRELLO_APP_KEY,
            appName: 'Start Project!'
        });

        // Function to create the member select UI
        function createMemberSelect(members) {
            var button = document.querySelector('.select-button'); // Select the member button
            var options = document.getElementById('member-options');

            members.forEach(function(member) {
                var option = document.createElement('div');
                option.className = 'option';
                option.textContent = member.fullName;
                option.dataset.memberId = member.id;
                option.onclick = function() {
                    this.classList.toggle('selected');
                    updateButtonText(button, options);
                };
                options.appendChild(option);
            });

            button.onclick = function(e) {
                e.stopPropagation();
                options.style.display = options.style.display === 'block' ? 'none' : 'block';
            };

            document.addEventListener('click', function() {
                options.style.display = 'none';
            });
        }

        // Function to create the label select UI
        function createLabelSelect(labels) {
            var button = document.querySelector('#label-select-container .select-button'); // Select the label button
            var options = document.getElementById('label-options');

            labels.forEach(function(label) {
                var option = document.createElement('div');
                option.className = 'option';
                option.textContent = label.name;
                option.dataset.labelId = label.id;
                option.onclick = function() {
                    this.classList.toggle('selected');
                    updateButtonText(button, options);
                };
                options.appendChild(option);
            });

            button.onclick = function(e) {
                e.stopPropagation();
                options.style.display = options.style.display === 'block' ? 'none' : 'block';
            };

            document.addEventListener('click', function() {
                options.style.display = 'none';
            });
        }

        function updateButtonText(button, options) {
            var selectedOptions = options.querySelectorAll('.option.selected');
            if (selectedOptions.length === 0) {
                button.textContent = button.dataset.defaultText || 'Select options';
            } else if (selectedOptions.length === 1) {
                button.textContent = selectedOptions[0].textContent;
            } else {
                button.textContent = selectedOptions.length + ' selected';
            }
        }

        // Populate members and labels when the popup is opened
        Promise.all([
            t.board('members'),
            t.card('labels') // Fetch labels from the source card
        ])
        .then(function([data, card]) {
            console.log('Fetched members:', data); // Log the data to see its structure
            createMemberSelect(data.members); // Access the members array from the data object
            console.log('Fetched labels:', card.labels);
            createLabelSelect(card.labels); // Pass the labels to the label select function
        })
        .catch(function(error) {
            console.error('Error fetching data:', error);
            document.getElementById('error').textContent = 'Error fetching data. Please try again.';
        });

        // Add event listener for the create button
        document.getElementById('createButton').addEventListener('click', function() {
            var suffix = document.getElementById('newCardSuffix').value.trim(); // Get the user-defined suffix and trim whitespace
            var sourceCardName = "Mama's Fried Chicken"; // Replace with the actual source card name
            var newCardName;

            // Construct the new card name based on the suffix
            if (suffix) {
                newCardName = `${sourceCardName}: ${suffix}`; // Format: "sourceCardName: suffix"
            } else {
                newCardName = sourceCardName; // Use the source card name if suffix is blank
            }

            console.log('New Card Name:', newCardName); // Log the new card name

            // Logic to create the project card goes here
        });
    </script>
</body>
</html>
