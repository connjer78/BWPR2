<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
        body { 
            padding: 10px; 
            overflow-y: auto;
        }
        .select-wrapper {
            margin-top: 5px;
        }
        .select-button {
            width: 100%;
            text-align: left;
            padding: 5px;
            background-color: var(--ds-surface);
            border: 1px solid var(--ds-border);
            border-radius: 3px;
            cursor: pointer;
        }
        .options {
            display: none;
            position: absolute;
            background-color: var(--ds-surface);
            border: 1px solid var(--ds-border);
            border-radius: 3px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }
        .option {
            padding: 5px;
            cursor: pointer;
        }
        .option:hover {
            background-color: var(--ds-background-neutral-hovered);
        }
        .option.selected {
            background-color: var(--ds-background-neutral-selected);
        }
    </style>
</head>
<body>
    <div id="error" class="error"></div>
    <div id="content">
        <div id="member-select-container" class="select-wrapper">
            <button class="select-button">Select members</button>
            <div class="options" id="member-options"></div>
        </div>
        <div id="label-select-container" class="select-wrapper">
            <button class="select-button">Select labels</button>
            <div class="options" id="label-options"></div>
        </div>
        <div class="select-wrapper">
            <label for="newCardSuffix">New Card Suffix:</label>
            <input type="text" id="newCardSuffix" placeholder="Enter suffix here" />
        </div>
        <button id="createButton" class="mod-primary">Create Project Card</button>
    </div>
    <script>
        var TRELLO_APP_KEY = '6fd96e65b3bbfbf2c88bd5eb871fab8a'; // Your API key
        var t = window.TrelloPowerUp.iframe({
            appKey: TRELLO_APP_KEY,
            appName: 'Start Project!'
        });

        let token; // Declare token in a higher scope

        // Function to fetch the token and store it
        function fetchToken() {
            return t.getRestApi().getToken()
                .then(fetchedToken => {
                    token = fetchedToken; // Store the token in a higher scope variable
                    console.log('Fetched token:', token);
                });
        }

        // Function to create the member select UI
        function createMemberSelect(members) {
            var button = document.querySelector('#member-select-container .select-button'); // Select the member button
            var options = document.getElementById('member-options');

            members.forEach(function(member) {
                var option = document.createElement('div');
                option.className = 'option';
                option.textContent = member.fullName;
                option.dataset.memberId = member.id;
                option.onclick = function() {
                    this.classList.toggle('selected');
                    updateButtonText(button, options);
                };
                options.appendChild(option);
            });

            button.onclick = function(e) {
                e.stopPropagation();
                options.style.display = options.style.display === 'block' ? 'none' : 'block';
            };

            document.addEventListener('click', function() {
                options.style.display = 'none';
            });
        }

        // Function to create the label select UI
        function createLabelSelect(labels) {
            var button = document.querySelector('#label-select-container .select-button'); // Select the label button
            var options = document.getElementById('label-options');

            labels.forEach(function(label) {
                var option = document.createElement('div');
                option.className = 'option';
                option.textContent = label.name;
                option.dataset.labelId = label.id;
                option.onclick = function() {
                    this.classList.toggle('selected');
                    updateButtonText(button, options);
                };
                options.appendChild(option);
            });

            button.onclick = function(e) {
                e.stopPropagation();
                options.style.display = options.style.display === 'block' ? 'none' : 'block';
            };

            document.addEventListener('click', function() {
                options.style.display = 'none';
            });
        }

        function updateButtonText(button, options) {
            var selectedOptions = options.querySelectorAll('.option.selected');
            if (selectedOptions.length === 0) {
                button.textContent = button.dataset.defaultText || 'Select options';
            } else if (selectedOptions.length === 1) {
                button.textContent = selectedOptions[0].textContent;
            } else {
                button.textContent = selectedOptions.length + ' selected';
            }
        }

        // Populate members and labels when the popup is opened
        Promise.all([
            t.board('members'),
            t.card('id', 'name', 'labels') // Fetch the full card details including name and labels
        ])
        .then(function([membersData, card]) {
            console.log('Fetched members:', membersData); // Log the data to see its structure
            createMemberSelect(membersData.members); // Access the members array from the data object
            console.log('Fetched labels:', card.labels);
            createLabelSelect(card.labels); // Pass the labels to the label select function

            // Log the entire card object to check its structure
            console.log('Fetched card:', card);

            // Retrieve the source card name
            var sourceCardName = card.name; // Get the name of the source card

            // Function to get all boards in the workspace (organization)
            function getAllBoardsInWorkspace() {
                console.log('Fetching all boards in the workspace...');

                // Fetch the authenticated user's organizations
                return t.getRestApi().getToken()
                    .then(function(token) {
                        // Fetch the organizations for the authenticated user
                        return fetch(`https://api.trello.com/1/members/me/organizations?key=${TRELLO_APP_KEY}&token=${token}`, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json'
                            }
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(organizations => {
                            console.log('Fetched organizations:', organizations); // Log the fetched organizations
                            if (organizations.length === 0) {
                                throw new Error('No organizations found for the user.');
                            }
                            const orgId = organizations[0].id; // Use the first organization ID
                            console.log('Using Organization ID:', orgId); // Log the organization ID

                            // Fetch boards for the organization
                            return fetch(`https://api.trello.com/1/organizations/${orgId}/boards?filter=open&fields=name,id&key=${TRELLO_APP_KEY}&token=${token}`, {
                                method: 'GET',
                                headers: {
                                    'Accept': 'application/json'
                                }
                            });
                        });
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(boards => {
                        console.log('Fetched boards:', boards); // Log the fetched boards
                        return boards; // Return the boards for further processing if needed
                    })
                    .catch(error => {
                        console.error('Error fetching boards:', error); // Log any errors
                        throw error; // Rethrow the error for further handling
                    });
            }

            // Example usage of the function
            getAllBoardsInWorkspace()
                .then(boards => {
                    // You can do something with the boards here if needed
                    console.log('Successfully retrieved boards:', boards);
                })
                .catch(error => {
                    console.error('Failed to retrieve boards:', error);
                });

            // Function to get the first list ID from the "Projects" board
            function getFirstListIdFromProjectsBoard() {
                console.log('Getting Projects board ID...');

                return t.getRestApi().getToken() // Fetch the token first
                    .then(function(token) {
                        return getAllBoardsInWorkspace()
                            .then(boards => {
                                // Find the "Projects" board
                                const projectsBoard = boards.find(board => board.name === 'Projects');
                                if (!projectsBoard) {
                                    throw new Error('Projects board not found.');
                                }
                                console.log('Found Projects board:', projectsBoard);

                                // Fetch the lists for the "Projects" board using the token
                                return fetch(`https://api.trello.com/1/boards/${projectsBoard.id}/lists?key=${TRELLO_APP_KEY}&token=${token}`, {
                                    method: 'GET',
                                    headers: {
                                        'Accept': 'application/json'
                                    }
                                });
                            });
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(lists => {
                        console.log('Fetched lists for Projects board:', lists);
                        if (lists.length === 0) {
                            throw new Error('No lists found in the Projects board.');
                        }
                        return lists[0].id; // Return the ID of the first list
                    })
                    .catch(error => {
                        console.error('Error fetching the first list ID:', error);
                        throw error; // Rethrow the error for further handling
                    });
            }

            // Example usage of the function
            getFirstListIdFromProjectsBoard()
                .then(listId => {
                    console.log('First list ID from Projects board:', listId);
                    // You can now use this listId to create new cards
                })
                .catch(error => {
                    console.error('Failed to retrieve the first list ID:', error);
                });

            // Function to create a new card in the first list of the "Projects" board
            function createCardInProjectsBoard(sourceCard) {
                console.log('Creating a new card in the Projects board...');

                return getFirstListIdFromProjectsBoard()
                    .then(listId => {
                        console.log('First list ID:', listId);
                        // Prepare the new card details
                        const newCardName = sourceCard.name; // Copy the name from the source card
                        const newCardDescription = sourceCard.desc; // Optionally copy the description

                        // Create the new card using the Trello API
                        return fetch(`https://api.trello.com/1/cards?key=${TRELLO_APP_KEY}&token=${token}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                name: newCardName,
                                desc: newCardDescription,
                                idList: listId // Use the ID of the first list
                            })
                        });
                    })
                    .then(response => {
                        console.log('Response from card creation API:', response); // Log the response
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(newCard => {
                        console.log('New card created successfully:', newCard);
                        // Optionally close the popup or provide feedback to the user
                        t.closePopup();
                    })
                    .catch(error => {
                        console.error('Error creating new card:', error);
                        throw error; // Rethrow the error for further handling
                    });
            }

            // Example button click handler to create a card
            document.addEventListener('DOMContentLoaded', () => {
                const createCardButton = document.getElementById('createCardButton');
                if (createCardButton) {
                    createCardButton.addEventListener('click', () => {
                        console.log('Create Card button clicked.'); // Log button click

                        const sourceCard = {
                            id: '67226ce3a49b474554362586',
                            name: 'Testinggg',
                            desc: 'This is a test card description.'
                        };

                        fetchToken() // Ensure the token is fetched before creating the card
                            .then(() => {
                                console.log('Token fetched successfully:', token);
                                return createCardInProjectsBoard(sourceCard);
                            })
                            .then(() => {
                                console.log('Card creation process completed.');
                                t.closePopup(); // Close the popup after successful creation
                            })
                            .catch(error => {
                                console.error('Failed to create the new card:', error);
                            });
                    });
                } else {
                    console.error('Button with ID "createCardButton" not found in the DOM.');
                }
            });
        })
        .catch(function(error) {
            console.error('Error fetching data:', error);
            document.getElementById('error').textContent = 'Error fetching data. Please try again.';
        });
    </script>
</body>
</html>
